<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Mic Permission Helper</title>
</head>
<body>
    <script>
        async function requestMic() {
            try {
                await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        channelCount: 1,
                    }
                });
                return { status: 'granted' };
            } catch (err) {
                console.warn('[Listening Buddy] Microphone permission not granted:', err);
                return { status: 'error', error: err?.name || err?.message || 'unknown' };
            }
        }

        // Listen for explicit requests from the content script (ideally triggered by a user gesture).
        window.addEventListener('message', async (event) => {
            const data = event.data || {};
            if (data.type !== 'REQUEST_MIC_PERMISSION' || !data.reqId) return;
            const result = await requestMic();
            window.parent.postMessage({ ...result, reqId: data.reqId }, '*');
        });

        // Best-effort auto request once per tab to pre-warm permission.
        (async () => {
            if (sessionStorage.getItem('mic-requested')) return;
            sessionStorage.setItem('mic-requested', '1');
            await requestMic();
        })();
    </script>
</body>
</html>
